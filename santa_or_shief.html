<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Çµ„É≥„Çø„Å®Ê≥•Ê£í„ÅÆÁÖôÁ™Å„Ç≤„Éº„É†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap');

        body {
            font-family: 'Mochiy Pop One', sans-serif;
            touch-action: manipulation;
            background-color: #1a202c;
            color: white;
            overflow: hidden;
        }

        #game-canvas {
            background-color: #2d3748;
            box-shadow: inset 0 0 20px #000;
        }

        .btn-press {
            transition: transform 0.1s;
        }

        .btn-press:active {
            transform: scale(0.95);
        }

        /* ÁÇé„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú */
        .fire-glow {
            box-shadow: 0 -10px 40px rgba(255, 69, 0, 0.6);
            border-color: #ef4444 !important;
            /* Red border when fire is on */
        }

        .water-glow {
            box-shadow: 0 -10px 40px rgba(0, 191, 255, 0.6);
            border-color: #3b82f6 !important;
            /* Blue border when water is on */
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-4px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(8px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-16px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(16px, 0, 0);
            }
        }
    </style>
</head>

<body class="h-screen w-screen flex flex-col items-center justify-center bg-gray-900">

    <!-- Game UI Overlay -->
    <div class="absolute top-4 left-0 w-full flex justify-between px-6 z-10 pointer-events-none">
        <div class="text-xl text-yellow-400 drop-shadow-md">SCORE: <span id="score">0</span></div>
        <div class="text-xl text-red-400 drop-shadow-md">SPEED: <span id="level">1</span></div>
    </div>

    <!-- Main Container -->
    <div
        class="relative w-full max-w-md h-full max-h-[800px] flex flex-col bg-gray-800 border-x-4 border-gray-700 shadow-2xl">

        <!-- Chimney Top Decoration -->
        <div
            class="h-16 bg-red-900 flex items-end justify-center border-b-8 border-gray-600 pattern-brick relative z-20">
            <div class="text-white text-sm opacity-50 mb-1">CHIMNEY</div>
        </div>

        <!-- Canvas Area -->
        <canvas id="gameCanvas" class="flex-grow w-full bg-slate-800"></canvas>

        <!-- Fireplace Base -->
        <div id="hearth"
            class="h-32 bg-stone-800 border-t-8 border-stone-600 relative flex items-center justify-center transition-all duration-300 z-20">
            <!-- Visual Feedback for State -->
            <div id="fire-visual"
                class="text-6xl absolute bottom-4 transition-opacity duration-200 opacity-0 filter drop-shadow-[0_0_10px_rgba(255,69,0,0.8)]">
                üî•</div>
            <div id="water-visual"
                class="text-6xl absolute bottom-4 transition-opacity duration-200 opacity-100 filter drop-shadow-[0_0_10px_rgba(0,191,255,0.8)]">
                üíß</div>

            <div class="absolute bottom-0 w-full h-4 bg-stone-900"></div>
            <!-- Brick pillars -->
            <div class="absolute left-0 top-0 h-full w-8 bg-red-900 border-r-4 border-stone-700"></div>
            <div class="absolute right-0 top-0 h-full w-8 bg-red-900 border-l-4 border-stone-700"></div>
        </div>

        <!-- Controls -->
        <div class="h-48 bg-gray-900 p-4 grid grid-cols-2 gap-4 z-20">
            <button id="btn-fire"
                class="btn-press rounded-xl bg-red-600 border-b-4 border-red-800 flex flex-col items-center justify-center active:border-b-0 active:mt-1 group">
                <span class="text-5xl mb-2 group-active:scale-110 transition-transform">üî•</span>
                <span class="font-bold text-white text-lg">ÁÇπÁÅ´ (Ê≥•Ê£í)</span>
            </button>
            <button id="btn-water"
                class="btn-press rounded-xl bg-blue-500 border-b-4 border-blue-700 flex flex-col items-center justify-center active:border-b-0 active:mt-1 group">
                <span class="text-5xl mb-2 group-active:scale-110 transition-transform">üíß</span>
                <span class="font-bold text-white text-lg">Ê∂àÁÅ´ („Çµ„É≥„Çø)</span>
            </button>
        </div>

        <!-- Start/Game Over Screen -->
        <div id="menu-overlay"
            class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-50 backdrop-blur-sm px-6">
            <h1 class="text-4xl mb-2 text-center text-red-500 font-bold drop-shadow-[0_2px_2px_rgba(255,255,255,0.8)]">
                XMAS<br>SORTING</h1>
            <p class="text-gray-300 mb-8 text-center text-base">
                <span class="block mb-2">„Çµ„É≥„Çø üéÖ ‚Üí <span class="text-blue-400 font-bold">Èùí (Ê∂àÁÅ´)</span></span>
                <span class="block">Ê≥•Ê£í üòé ‚Üí <span class="text-red-400 font-bold">Ëµ§ (ÁÇπÁÅ´)</span></span>
            </p>
            <div id="result-msg" class="text-2xl text-yellow-400 mb-6 font-bold hidden text-center whitespace-pre-wrap">
            </div>
            <button id="start-btn"
                class="px-10 py-5 bg-green-600 hover:bg-green-500 text-white rounded-full font-bold text-2xl shadow-[0_0_20px_rgba(74,222,128,0.5)] transform transition hover:scale-105 active:scale-95">
                START
            </button>
        </div>
    </div>

    <script>
        // Game Constants
        const CANVAS = document.getElementById('gameCanvas');
        const CTX = CANVAS.getContext('2d');
        const HEARTH_EL = document.getElementById('hearth');
        const FIRE_VISUAL = document.getElementById('fire-visual');
        const WATER_VISUAL = document.getElementById('water-visual');
        const SCORE_EL = document.getElementById('score');
        const LEVEL_EL = document.getElementById('level');
        const MENU_EL = document.getElementById('menu-overlay');
        const START_BTN = document.getElementById('start-btn');
        const RESULT_MSG = document.getElementById('result-msg');

        // Sounds (simulated)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'good') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'bad') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'fire') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            }
        }

        // Game State
        let gameState = {
            isPlaying: false,
            score: 0,
            speedMultiplier: 1.0,
            isFireOn: false,
            entities: [],
            lastSpawnTime: 0,
            spawnInterval: 2000,
            width: 0,
            height: 0
        };

        // Assets
        const ASSETS = {
            santa: 'üéÖ',
            thief: 'üòé', // High contrast sunglasses face
            present: 'üéÅ',
            bag: 'üí∞'
        };

        // Resize Handling
        function resize() {
            gameState.width = CANVAS.clientWidth;
            gameState.height = CANVAS.clientHeight;
            CANVAS.width = gameState.width;
            CANVAS.height = gameState.height;
        }
        window.addEventListener('resize', resize);
        resize();

        // Entity Class
        class Entity {
            constructor() {
                this.type = Math.random() > 0.5 ? 'santa' : 'thief';
                this.x = gameState.width / 2;
                this.y = -60;
                this.radius = 45; // Increased radius for visibility background
                // Speed formula
                this.speed = (3 + Math.random() * 1.5) * gameState.speedMultiplier;
                this.wobbleOffset = Math.random() * Math.PI * 2;
            }

            update() {
                this.y += this.speed;
                // Wobble
                this.x = (gameState.width / 2) + Math.sin(this.y * 0.015 + this.wobbleOffset) * 15;
            }

            draw(ctx) {
                // Draw Background Circle for visibility
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);

                if (this.type === 'santa') {
                    // White background for Santa
                    ctx.fillStyle = '#ffffff';
                    ctx.fill();
                    // Optional: Red glow
                    ctx.shadowColor = 'rgba(255, 255, 255, 0.5)';
                    ctx.shadowBlur = 10;
                } else {
                    // Dark purple/grey background for Thief
                    ctx.fillStyle = '#4c1d95'; // Violet-900
                    ctx.fill();
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = '#c084fc'; // Violet-400 border
                    ctx.stroke();
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 0;
                }

                // Reset shadow for text
                ctx.shadowBlur = 0;

                // Draw the character Emoji
                ctx.font = "60px Arial"; // Larger font
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                const emoji = this.type === 'santa' ? ASSETS.santa : ASSETS.thief;
                // Adjust Y slightly to center emoji visually in circle
                ctx.fillText(emoji, this.x, this.y + 5);

                // Draw item they are holding (smaller icon badge)
                ctx.font = "28px Arial";
                const item = this.type === 'santa' ? ASSETS.present : ASSETS.bag;
                // Position item at bottom right of circle
                ctx.fillText(item, this.x + 25, this.y + 25);
            }
        }

        // Controls
        function setFireState(isOn) {
            gameState.isFireOn = isOn;
            playSound('fire');
            updateHearthVisuals();
        }

        function updateHearthVisuals() {
            if (gameState.isFireOn) {
                HEARTH_EL.classList.add('fire-glow');
                HEARTH_EL.classList.remove('water-glow');
                FIRE_VISUAL.classList.remove('opacity-0');
                WATER_VISUAL.classList.add('opacity-0');
            } else {
                HEARTH_EL.classList.remove('fire-glow');
                HEARTH_EL.classList.add('water-glow');
                FIRE_VISUAL.classList.add('opacity-0');
                WATER_VISUAL.classList.remove('opacity-0');
            }
        }

        // Mouse/Touch Events
        const btnFire = document.getElementById('btn-fire');
        const btnWater = document.getElementById('btn-water');

        const handleInteraction = (e, isOn) => {
            if (e.cancelable) e.preventDefault();
            setFireState(isOn);
        };

        btnFire.addEventListener('mousedown', (e) => handleInteraction(e, true));
        btnFire.addEventListener('touchstart', (e) => handleInteraction(e, true), { passive: false });

        btnWater.addEventListener('mousedown', (e) => handleInteraction(e, false));
        btnWater.addEventListener('touchstart', (e) => handleInteraction(e, false), { passive: false });

        // Keyboard support
        window.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            if (e.key === 'ArrowRight' || e.key === 'd') setFireState(false);
            if (e.key === 'ArrowLeft' || e.key === 'a') setFireState(true);
        });


        // Game Loop
        function loop(timestamp) {
            if (!gameState.isPlaying) return;

            // Clear Canvas
            CTX.clearRect(0, 0, gameState.width, gameState.height);

            // Draw Background Soot/Snow particles
            CTX.fillStyle = 'rgba(255, 255, 255, 0.1)';
            for (let i = 0; i < 15; i++) {
                // Simple pseudo-random background effect based on time
                let x = (Math.sin(i * 132 + timestamp * 0.0002) * 0.5 + 0.5) * gameState.width;
                let y = (timestamp * 0.1 + i * 100) % gameState.height;
                CTX.beginPath();
                CTX.arc(x, y, 2, 0, Math.PI * 2);
                CTX.fill();
            }

            // Spawn Logic
            if (timestamp - gameState.lastSpawnTime > gameState.spawnInterval) {
                gameState.entities.push(new Entity());
                gameState.lastSpawnTime = timestamp;
                // Difficulty scaling: faster spawns, cap at 500ms
                gameState.spawnInterval = Math.max(500, 2000 - (gameState.score * 60));
            }

            // Update & Draw Entities
            for (let i = gameState.entities.length - 1; i >= 0; i--) {
                let ent = gameState.entities[i];
                ent.update();
                ent.draw(CTX);

                // Collision Detection (Hit hearth area)
                // Hearth is approx 130px tall in CSS, but let's say "hit" is when they reach bottom area
                // Canvas height matches visual height above hearth. 
                // Wait, canvas is "flex-grow", hearth is separate div below. 
                // So collision is when y > canvas.height - radius

                if (ent.y > gameState.height + ent.radius) {
                    // Technically they passed through the canvas, now checking logic
                    checkCollision(ent);
                    gameState.entities.splice(i, 1);
                }
            }

            requestAnimationFrame(loop);
        }

        function checkCollision(entity) {
            let success = false;
            let message = "";

            if (entity.type === 'santa') {
                // Santa needs WATER (fire OFF)
                if (gameState.isFireOn) {
                    success = false;
                    message = "„Ç¢„ÉÅ„ÉÅÔºÅ\n„Çµ„É≥„Çø„ÇíÁáÉ„ÇÑ„Åó„Å¶„Åó„Åæ„Å£„Åü...";
                } else {
                    success = true;
                }
            } else {
                // Thief needs FIRE (fire ON)
                if (gameState.isFireOn) {
                    success = true;
                } else {
                    success = false;
                    message = "„Åæ„Åö„ÅÑÔºÅ\nÊ≥•Ê£í„Å´ÂÖ•„Çâ„Çå„ÅüÔºÅ";
                }
            }

            if (success) {
                gameState.score++;
                // Difficulty scaling: faster drop speed
                gameState.speedMultiplier += 0.08;
                SCORE_EL.innerText = gameState.score;

                let lvl = Math.floor(gameState.score / 5) + 1;
                LEVEL_EL.innerText = lvl;

                playSound('good');

                // Visual feedback
                showFloatingText(success ? "OK!" : "MISS", gameState.width / 2, gameState.height - 50, success ? "#4ade80" : "#ef4444");

            } else {
                gameOver(message);
            }
        }

        function showFloatingText(text, x, y, color) {
            // Simple instant draw, in a real engine we'd add to an array of particles
            // For now, let's just flash the screen or rely on sound as the main feedback for hits,
            // but we can draw a quick overlay frame if we wanted.
            // Actually, let's just let the score update be the feedback for success.
        }

        function gameOver(reason) {
            gameState.isPlaying = false;
            playSound('bad');
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 500);

            RESULT_MSG.innerText = `SCORE: ${gameState.score}\n${reason}`;
            RESULT_MSG.classList.remove('hidden');
            MENU_EL.classList.remove('hidden');
            START_BTN.innerText = "„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÈÅä„Å∂";
        }

        function startGame() {
            gameState.isPlaying = true;
            gameState.score = 0;
            gameState.speedMultiplier = 1.0;
            gameState.entities = [];
            gameState.spawnInterval = 2000;
            gameState.lastSpawnTime = performance.now();
            gameState.isFireOn = false;

            SCORE_EL.innerText = "0";
            LEVEL_EL.innerText = "1";
            MENU_EL.classList.add('hidden');
            RESULT_MSG.classList.add('hidden');

            updateHearthVisuals();
            resize();
            requestAnimationFrame(loop);
        }

        START_BTN.addEventListener('click', startGame);

        updateHearthVisuals();

    </script>
</body>

</html>